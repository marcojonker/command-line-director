name: Publish Release

on:
  workflow_dispatch:
    inputs:
      release-type:
        description: 'Release type to bump'
        required: true
        default: 'beta'
        type: choice
        options:
          - minor
          - patch
          - beta
          - major
      dry-run:
        description: 'Full dry run: do not push tags or create GitHub release; npm publish will run with --dry-run'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  publish:
    name: Publish release (manual)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure running on master
        run: |
          if [ "${GITHUB_REF#refs/heads/}" != "master" ]; then
            echo "This workflow is only allowed on the master branch (current: $GITHUB_REF).";
            exit 1;
          fi

      - name: Use Node.js 18.x
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Install dependencies
        run: npm install

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Run prepare
        run: npm run prepare

      - name: Dry run mode
        if: ${{ fromJson(github.event.inputs['dry-run']) }}
        run: |
          echo "Full dry run enabled: will NOT push tags or create a GitHub Release. npm publish will run with --dry-run."

      - name: Bump version (npm)
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          RELEASE_TYPE: ${{ github.event.inputs['release-type'] }}
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          if [ "$RELEASE_TYPE" = "beta" ]; then
            npm version prerelease --preid=beta -m "chore(release): %s"
          else
            npm version "$RELEASE_TYPE" -m "chore(release): %s"
          fi

      - name: Ensure NPM token is available
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          DRY_RUN: ${{ github.event.inputs['dry-run'] }}
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            echo "Dry run: skipping NPM_TOKEN check"
          else
            if [ -z "$NPM_TOKEN" ]; then
              echo "Missing NPM_TOKEN secret. Set a repository secret named 'NPM_TOKEN'." >&2
              exit 1
            fi
          fi

      - name: Configure npm auth
        if: ${{ !fromJson(github.event.inputs['dry-run']) }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

      - name: Publish to npm
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          DRY_RUN: ${{ github.event.inputs['dry-run'] }}
          RELEASE_TYPE: ${{ github.event.inputs['release-type'] }}
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            if [ "$RELEASE_TYPE" = "beta" ]; then
              npm publish --tag beta --dry-run
            else
              npm publish --dry-run
            fi
          else
            if [ "$RELEASE_TYPE" = "beta" ]; then
              npm publish --tag beta --access public
            else
              npm publish --access public
            fi
          fi


      - name: Get new version
        id: get_version
        run: |
          version=$(node -p "require('./package.json').version")
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Push commit and tags
        if: ${{ !fromJson(github.event.inputs['dry-run']) }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push --follow-tags origin HEAD:refs/heads/master

      - name: Create GitHub release
        if: ${{ !fromJson(github.event.inputs['dry-run']) }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          release_name: Release v${{ steps.get_version.outputs.version }}
          body: "Automated ${{ github.event.inputs.release-type }} release of v${{ steps.get_version.outputs.version }}"
          draft: false
          prerelease: ${{ github.event.inputs['release-type'] == 'beta' }}
